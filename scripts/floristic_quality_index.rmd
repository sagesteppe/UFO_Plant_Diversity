---
title: "Floristic Quality Index"
author: NULL
date: NULL
output:
  pdf_document: default
  word_document: default
header-includes:
 - \usepackage[width=\textwidth]{caption}
 - \usepackage{enumitem}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

Floristic Quality Assessments (FQA) utilize the presence of vascular plant species in an area as indicators of the quality of the habitat. The fundamental assumption guiding the use of plants as indicators of habitat quality is that different species respond differently to the types and frequencies of disturbance. At one end of this spectrum are species which are able to persist, or may introduced to an area, after certain types of disturbance - e.g. compaction of soil via heavy vehicles. On the other end of the spectrum are taxa which may only grow in areas which receive episodic disturbances characteristic of their ecosystem - e.g. a 100 year flood in a wetland. The subjectively estimated likelihood of a species either persisting, or being removed from a site due to disturbance is expressed as a Conservatism Value (C-Value). C-Values range from 1 to 10 for plants native to North America, and 0 for plants introduced to the continent by since colonization by European Settlers, with highly disturbance tolerant plants being at the upper end of the spectrum. 

The use of FQI are uncommon in the Bureau of Land Management, perhaps in part due to the FQI originating in the Midwest in, and the assignment of C-values being a task which requires considerable amounts of human resources (@spyreas2019floristic). A further requirement which hampers the utilization of these metrics are that each individual plant species, often times including subspecies, is assigned a separate C-value,  the number of land management professionals which are capable of distinguishing taxa at these resolutions are limited (@kramer2015report, @ahrends2011conservation, @morrison2016observer). Other possible limiting factors are that the FQI indices have been traditionally associated with the portions of Natural Resources focused on designation of parcels for conservation and preservation, rather than land management. 

While C-values exist for virtually all states East of the Continental Divide, Colorado is one of only two states with significant surface lands administered by the BLM which has existing C-values for every documented member of it's flora (@spyreas2019floristic); additionally BLM Colorado staff, including the lead state botanist, assisted in developing these scores (@cnhp2020fqi). Here we utilize C-values, to supplement our formal AIM analysis, and to attempt to develop a map of the habitat quality of the UFO field office. 

The Floristic Quality (FQ) Assessments are comprised of two core indices Mean Coefficient of Conservatism (Mean C) and Floristic Quality Index (FQI) (see Appendix A for equations). While many novel permutations of these calculations exist, they seem to offer little insight in addition to the pair of main indices and appear only useful for niche applications (@spyreas2019floristic). As the general goal of the FQA is the assessment of parcels of land, the location of study areas across different habitat types is accepted, and as we used a weighted stratified sample design our points meet the assumptions implicit in the FQA sample design (CITE, @spyreas2019floristic). FQ Assessments have yet to converge on a standardized size for conducting the species inventory, and while Mean-C is affected by plot size FQI is relatively robust against small plot size, however the size of the AIM plot has been shown to be adequate for noting enough species to conduct the analyses (@spyreas2016scale). In several applications C-values have been shown to be stable across sampling time, in part perhaps due to a propensity for many species at a site to share the same C-values (@spyreas2016scale, @matthews2015null, @bried2013floristic). C-values have also been shown capable of distinguishing habitat variability more effectively than the traditional  diversity metrics (@taft2006estimating). Practicioners of varying degrees of skill are likely to have minimal effects on the estimates of the FQA indices due to the species encoding some degrees of redundant information (@bried2018experts, @spyreas2019floristic).

Utility and Limitations of FQA

FQA scores are tied to the regional list of C-values, accordingly they cannot be compared across these regions, in other words the FQA scores of sites in the mixed grass prairies of Kansas and Colorado are incomparable. Scores have the potential to be misleading if compared across major habitats, (e.g. comparing sagebrush steppe to Salt desert). The score is relatively boundless, e.g. we could visit plots which we designate high quality and use them as benchmark for FQI values, but we cannot incorporate metrics e.g. land > 4 is 'good', until we consider these locally relevant measurements. 

> _'... tolerance of anthropogenic disturbance and exclusivity to remnant habitats are the only validated criteria for deﬁning FQA.'_
> `r tufte::quote_footer('--- Spyreas 2019')`


> _"...FQA conveys two things about high conservative species: (1) All else being equal, they have greater conservation value, and (2) they reﬂect a site’s history of minimal disturbance and degradation."_
> `r tufte::quote_footer('--- Spyreas 2019')`


# Methods

Cleaned AIM species richness data were imported from TerrAdat and joined to the CNHP c-values using the lookup keys developed for the Functional Diversity section. All species from the plot based species richness which were not unamibgiously identified to terminal taxon were droppped from analysis. The Mean Coefficient of Conservatism and Floristic Quality Index were calculated via the formulation in the appendix. To determine whether their were bias in the MCoC values between the strata, a linear model with a single set categorical predictors and a single continuous response (an 'ANOVA'; Analysis of Variance) was used, with a Kruskall-Wallis Post-hoc test with 95% Confidence Intervals. The strata used for detecting differences were those developed in SECTION XXX.

Estimates of the total portion of each parcel of BLM land's condition at certain Mean COC values were calculated using the 'cont_analysis' function from spsurvey. This function was used due to BLM not having metrics of benchmarks, nor what constitutes land meeting them for FQA. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

```{r load libraries and define functions}
library(tidyverse)
library(sf)
library(ggpubr)
library(spsurvey)
source('functions.R')
mcoc <- function(x){sum(x)/length(x)} 
fqi <- function(x){sum(x)/length(x) * sqrt(length(x))}

rm(convex_hull_resample)
```

```{r Import AIM Species Richness Data}
praw <- '../data/raw'
ppro <- '../data/processed'
f <- list.files(praw, pattern = 'csv')
fp <- list.files(ppro, pattern = 'csv')

spp_richness <- read.csv(file.path(praw, f[grep('SpeciesRichness[.]', f)])) %>% 
  select(SpeciesList, PrimaryKey)
spp_r_header <- read.csv(file.path(praw, f[grep('RichnessHeader', f)])) %>% 
  select(FormDate, Observer, PrimaryKey)

pts <- st_read(
  '../../aimDB/data/raw/AIM_Sample_Design/AIM_Design_Stratification.shp',
                quiet = T) %>% 
  st_transform(26913) %>% 
  st_buffer(65) %>% 
  select(PLOTID, STRATUM) 

char <- read.csv(file.path(praw, f[grep('Characterization', f)] ) ) %>% 
  st_as_sf( coords = c('Longitude', 'Latitude'), crs = 4269) %>% 
  filter(str_detect(PrimaryKey, negate = T,
                    'Fuels|Bull-Draw|CO-NWD|_Tres_Rios|Grand_Junction|Gunnison|Moab|TRFO'),
         str_detect(PlotID, '[A-Z]{2,3}-[0-9]{2,3}')) %>% 
  st_transform(26913) %>% 
  select(PrimaryKey) 

spp_richness <- st_intersection(pts, char)  %>% 
  left_join(., spp_r_header, by = 'PrimaryKey', multiple = "all") %>% 
  left_join(., spp_richness, by = 'PrimaryKey', multiple = "all") %>% 
  rename(SYMBOL_AIM = SpeciesList)  %>% 
  select(PLOTID, STRATUM, SYMBOL_AIM, geometry)

no_records_full <- nrow(spp_richness)

rm(pts, char, spp_r_header)
```
 
```{r Join C Values to Species Richness}

# remove unknowns here, only 118 records total across 5 years, pretty impressive!
unks <- spp_richness %>% 
  filter(str_detect(SYMBOL_AIM, '^AG|^PG|^AF|^PF|^SH\\d+')) %>%
  nrow()

spp_richness <- spp_richness %>% 
  filter(str_detect(SYMBOL_AIM, '^AG|^PG|^AF|^PF|^SH\\d+', negate = T))

# add on the official USDA codes to the AIM codes to sync up with CNHP
attributes <- read.csv(
  file.path(ppro, fp[grep('Attribute.*Table-RCB', fp)]) ) %>% 
  select(SYMBOL_AIM, SYMBOL_USDA) %>% 
  distinct(.keep_all = T)   # one duplicate in here somewhere!

spp_clean <- left_join(spp_richness, attributes, by = 'SYMBOL_AIM', multiple = "all") %>% 
  mutate(SYMBOL_USDA = if_else( is.na(SYMBOL_USDA), SYMBOL_AIM, SYMBOL_USDA))

cvals <- read.csv(file.path(ppro, fp[grep('C-Values', fp)])) %>% 
  select(SYMBOL_USDA = National_USDASymbol, C.Val = FQA_C.Value2020_Numeric, Native = FQA_NativeStatus, 
         Ack_SciName_noAuthority)

spp_clean <- left_join(spp_clean, cvals, by = 'SYMBOL_USDA', multiple = "all") %>% 
  # due to multiple look ups we will remove duplicate records
  group_by(PLOTID, SYMBOL_USDA) %>% 
  slice_sample(n = 1)

# spp_clean %>%  # check for duplicates here. 
#  group_by(PLOTID, SYMBOL_USDA) %>% 
#  filter(n() > 1)

no_CVAL_match <- filter(spp_clean, is.na(C.Val)) %>% 
  nrow()

spp_clean <- drop_na(spp_clean) %>% 
  group_by(PLOTID)

rm(cvals, attributes)
```

```{r Calculate Coefficients}
FQI_results <- spp_clean %>% 
  summarize(mcoc_r = mcoc(C.Val), 
            fqi_r = fqi(C.Val)) %>% 
  st_as_sf()

rm(fqi, mcoc)
```

```{r map coefficients}
ggplot(FQI_results) + 
  geom_sf() + 
  
  geom_point( aes(fill = mcoc_r, size = fqi_r, geometry = geometry),
    stat = "sf_coordinates", shape = 21
  ) +
  scale_fill_viridis_c('Mean C', option = "C", alpha = 0.6, direction = -1) +
  scale_size_binned('FQI') +
  theme_void() +
  theme(legend.position = "right")

```


```{r add strata to site}

lc_lkp <- read.csv(file.path(praw, f[grep('landcover', f)]) )  %>% 
  cbind(., RealStratum = c('MC', 'AS', 'MMS', 'PJ', 'SD', 'SS'))
r <- terra::rast('../../plot_post_stratification/data/processed/PredictedVegClass.tif')
pts <- FQI_results %>% 
  select(PLOTID) %>% 
  terra::vect() %>% 
  terra::project(terra::crs(r))

reclass <- terra::extract(r, pts, method = 'simple', bind = T) %>% 
 as.data.frame() %>% 
  mutate(lyr1 = case_when(
         PLOTID %in% c('SS-313-', 'PJ-143', 'PJ-153', 'PJ-164', 'SS-313') ~ 4, 
         PLOTID %in% c('AS-002', 'AS-004', 'MMS-097') ~ 3, 
         PLOTID %in% c('MC-068', 'AS-012') ~ 2, 
         PLOTID %in% c('SS-306') ~ 6,
         TRUE ~ lyr1)) 
         
FQI_results <- left_join(FQI_results, reclass, by = 'PLOTID') %>% 
  left_join(., lc_lkp, by = c('lyr1' = 'layer')) %>% 
  select(-lyr1) %>% 
  relocate(stratum, .before = geometry) %>% 
  st_as_sf() %>% 
  mutate(stratum = str_trim(stratum)) 

rm(r, pts, reclass, lc_lkp)
```


```{r determine whether the metrics vary by classified stratum}

wghts <- read.csv( file.path(praw, f[grep('Weights', f)])) %>% 
  select(WghtPerPlot, STRATUM = Stratum, AoInference = Area)

fqi_weights <- read.csv(file.path(praw, f[grep('Interence', f)])) %>% 
  select(PLOTID = Plot.ID, AoInference, xcoord, ycoord) %>% 
  right_join(., FQI_results, by = 'PLOTID') %>% 
  rowwise() %>% 
  mutate(STRATUM = str_remove(str_extract(PLOTID, '^.*-'), '-')) %>% 
  left_join(., wghts, by = c('STRATUM','AoInference'))

rm(wghts)
```

```{r Plot difference of MCOC by stratum}

fqi_weights_sub <- fqi_weights %>% filter(RealStratum != 'AS')
coc_box <- boxplot_drawer(df = fqi_weights_sub, response = mcoc_r, 
                     group = RealStratum, col_pal = strata_pal) +
  labs(title = 'Mean CoC by Stratum', x = 'Stratum', y = 'Mean Coefficient of Conservatism') 

fqa_meds <- fqi_weights_sub %>% 
  group_by(RealStratum) %>% 
  summarize(med_C = median(mcoc_r),
            mean_C = mean(mcoc_r))

rm(fqi_weights_sub, theme_boxplot, boxplot_drawer, strata_pal)
```

The floristic quality index data are independent of the ecological sites. Accordingly, we can create a statistical using the plots which were sampled, and predict the values of floristic quality across the field office. Based on the map above, and our field experience collecting these data, we suspected that the variables which are most related to the FQI scores, and which we could readily acquire or create were: 1) distance to nearrest road, 2) patch size of federal public lands, 3) the human population density within ~ 10 km (~6 miles), 4) elevation. These analyses occurred across the extent of the mapped area in Figure 1), at a resolution of 90meters. To calculate the distance of each 90m pixel of BLM land from the nearest road, the U.S. Census Bureau's 'roads' data set was acquired through 'tigris' and simplified using st_simplify, the distance function of 'terra' was then used to calculate the distances to nearest roads. The tigris dataset contains nearly all of 'major' dirt and gravel roads across the field office, included many used for historic mining activities. To calculate the patch size of federal lands, i.e. all area, across BLM Forest Service and National Park Service managements, not dissected by a road the PAD-US database was converted into a raster using 'rasterize' from terra, 

```{r Predict FQI across field office - prepare covariates, eval = F}
library(terra)
library(tigris)

rp <- '../../AIM_Field_rasters'
rf <- list.files(rp, recursive = T, pattern = 'tif')
p2carto <- '../../UFO_cartography'

vector_data <- list.files(p2carto, recursive = T, pattern = 'shp$')
popDen28 <- rast(file.path(rp, rf[grep('population.*28', rf)] ))
popDen38 <- rast(file.path(rp, rf[grep('population.*38', rf)] ))

# import extent file
ext <- vect('../../UFO_cartography/UFO_mask/mask/mask.shp') 

ext_84 <- ext %>% 
  project(crs(popDen)) %>% 
  ext()

## import elevation data at 90m resolution
elev90 <- rast(file.path(p2carto, list.files(p2carto, recursive = T, pattern = 'DEM.*tif')))
elev90 <- crop(elev90, ext)

################          Human population Density          ####################
# data were downloaded on Feb 21, 14:15 CST, from (HDX)[https://data.humdata.org/dataset/united-states-high-resolution-population-density-maps-demographic-estimates] 
# for the area 38N - 48N, 100 - 110W. These data were cropped and masked to the outer extent of the UFO field office. 

# crop to extent of analysis
popDen <- mosaic(popDen28, popDen38, fun = 'mean', overwrite = T,
                 filename = file.path(rp, 'PopDensity_mosaic.tif'))

popDen <- crop(popDen, ext_84, mask = T, overwrite = T)

# aggregate to 90m resolution
popDen_c <- aggregate(popDen, fact=3, cores=20, fun = 'sum', na.rm = T)

# create a rolling window SUM, over 2070m (~2 km)
popDen_c <- focal(popDen_c, w = 23, fun = 'sum', expand = T, overwrite = T, na.rm = T)

# project into planar coordinates
popDen_c <- project(popDen_c, crs(ext), overwrite = T, filename = 
                      file.path(rp, 'PopDensity_planar.tif'))
popDen_c <- resample(popDen_c, elev90, overwrite = T, filename = 
                       file.path(rp, 'PopDensity_planar_resamp.tif'))

rm(popDen, popDen28, popDen38, ext_84)

################# patch size of contiguous public land - PADUS #################
padus <- st_read(
  file.path(p2carto, vector_data[grep('PAD.*Fee*', vector_data)]), quiet = T) %>% 
  filter(Mang_Type == 'FED') %>% 
  group_by(Mang_Type) %>% 
  summarize(geometry = st_union(geometry)) %>% 
  st_cast(., to = "POLYGON")  %>% 
  mutate(AreaHA = as.numeric(st_area(.)) / 10000 )

patchsize_r <- padus %>% 
  vect() %>% 
  rasterize(., elev90, 'AreaHA',
            background = 0)

writeRaster(patchsize_r, file.path(rp, 'public_patchsize.tif'))

####################### distance from nearest road #############################
# ensure that roads data are in planar coordinates systems before converting
# simplify roads data 

ext_sf <- st_read('../../UFO_cartography/UFO_mask/mask/mask.shp')

CO <- counties(state = 'CO', cb = T)  %>%
  select(COUNTYFP, NAME ) %>% 
  st_transform(st_crs(ext_sf))
counties <- st_join(ext_sf, CO) %>% pull(COUNTYFP)

CO_roads <- roads(state = 'CO', county = counties, keep_zipped_shapefile = T) %>% 
  st_transform(st_crs(ext_sf)) %>% 
  st_crop(., ext_sf) %>% 
  st_simplify() %>% 
  select(geometry) %>% 
  st_cast('LINESTRING') %>% 
  st_as_sfc()

rm(CO, counties)

##  now create distance to nearest roads  raster  ###

CO_roads_v <- vect(CO_roads)
road_raster <- rasterize(CO_roads_v, elev_90,
            background = NA)
m90_r <- distance(road_raster)
writeRaster(m90_r, file.path(rp, '90m_RoadDistance.tif'), overwrite = T)

rm(time90m, flat_lines_psp, L, CO_roads, m90_r, CO_roads_v, road_raster)
```



```{r prepare raster stack for FQI prediction}
library(terra)

rp <- '../../AIM_Field_rasters'
rf <- list.files(rp, recursive = T, pattern = 'tif')
p2carto <- '../../UFO_cartography'

ext <- vect('../../UFO_cartography/UFO_mask/mask/mask.shp') 

elev_90 <- rast(file.path(p2carto, list.files(p2carto, recursive = T, pattern = 'DEM.*tif')))
elev_90 <- crop(elev_90, ext)

popDen <- rast(file.path(rp, rf[grep( 'PopD.*resamp', rf)]))
roadDist <- rast(file.path(rp, rf[grep( 'RoadDistance', rf)]))
patch <- rast(file.path(rp, rf[grep( 'public_patchsize.tif', rf)]))

popDen <- crop(popDen, elev_90)
popDen <- resample(popDen, elev_90)
popDen[is.na(popDen[])] <- 0
patch <- crop(patch, elev_90)
patch <- resample(patch, elev_90)
roadDist <- crop(roadDist, elev_90)
roadDist <- resample(roadDist, elev_90)

# make X and Y coords explicit layers in the model. 
x_rast <- rast(elev_90)
x_rast <- init(x_rast, "x")

y_rast <- rast(elev_90)
y_rast <- init(y_rast, "y")

pred_stack <- c(elev_90, popDen, patch, roadDist, x_rast, y_rast)
names(pred_stack) <- c('elevation', 'pop_density', 'patch_size', 'road_dist',
                       'xcoord', 'ycoord')

rm(elev_90, popDen, patch, roadDist, x_rast, y_rast)
```


```{r Dredge a consensus model}

# Run automated model selection 
library(MuMIn)
library(usdm)

# check for correlation among the independent variables from 5000 random cells
corr_check_sample <- terra::spatSample(pred_stack, size = 5000, method = 'regular')
vif_results <-  usdm::vifstep(corr_check_sample, th=10)
vif_results

rm(corr_check_sample, vif_results)

## extract values to AIM Plots
fqa_results_V <- FQI_results %>% 
  dplyr::select(PLOTID, mcoc_r) %>% 
  vect()
fqa_rast_vals <- extract(pred_stack, fqa_results_V,  bind = T) %>%
  data.frame()

# pull off plotID
fqa_rast_vals <- dplyr::select(fqa_rast_vals, -PLOTID)
fqa_rast_vals <- fqa_rast_vals[complete.cases(fqa_rast_vals),]

## attempt to model FQA as a function of human disturbance, and elevation. 

# this is the theoretical full model:
glm(mcoc_r ~ road_dist * pop_density * patch_size * elevation * xcoord * ycoord, data = fqa_rast_vals)

oop <- options(na.action = "na.fail")

full_model <- glm(mcoc_r ~ ., data = fqa_rast_vals)
optimal_models <- dredge(full_model)
optimal_models

# gather the actual terms from the top performing models, to see what worked.
model_terms <- get.models(optimal_models, subset = T)

# if top models have dAIC < 2.0, than 'stack' the models
stacked_model <- model.avg(optimal_models, subset = delta < 2, fit = T)

# these provides the estimates of our coefficients
stacked_model$coefficients

# identify out top component models
stacked_model

```


```{r stack the top models}
head(model_terms)


# we will create predictions from EACH model with dAIC < 2.0 and then take the m
# mean of each model 
model_terms[["20"]][["call"]]
model_terms[["18"]][["call"]]
model_terms[["28"]][["call"]]
model_terms[["24"]][["call"]]
model_terms[["52"]][["call"]]

model_20 <- glm(formula = mcoc_r ~ elevation + patch_size + xcoord + 1, data = fqa_rast_vals)
model_18 <- glm(formula = mcoc_r ~ elevation + xcoord + 1, data = fqa_rast_vals)
model_28 <- glm(formula = mcoc_r ~ elevation + patch_size + road_dist + xcoord +  1, data = fqa_rast_vals)
model_24 <- glm(formula = mcoc_r ~ elevation + patch_size + pop_density +  xcoord + 1, data = fqa_rast_vals)
model_52 <- glm(formula = mcoc_r ~ elevation + patch_size + xcoord + ycoord +  1, data = fqa_rast_vals)

top_pred_r <- c(
  pred_20 <- predict(pred_stack, model_20, type="response"),
  pred_18 <- predict(pred_stack, model_18, type="response"),
  pred_28 <- predict(pred_stack, model_28, type="response"),
  pred_24 <- predict(pred_stack, model_24, type="response"),
  pred_52 <- predict(pred_stack, model_52, type="response")
)

plot(top_pred_r) # model 4 is bogus
top_pred_r <- subset(top_pred_r, c(1:3, 5))
top_pred_r <- mean(top_pred_r)
plot(top_pred_r)

# create a simple ensemble, by calculating the mean of each top model

rm(model_18, model_20, model_24, model_28, model_52, )
```


```{r}
rm(my_range)
```

# Discussion

```{r print stratum comparisions, fig.cap='Median Values of Coefficient of Conservation by Stratum', out.width="50%"}
coc_box

my_range <- function(x, col){
  paste(round(min(x[,col]),2), '-', round(max(x[,col]),2) )
}

```

The mean C-Values varied by stratum (Analysis of Variance (ANOVA), ...), follow-up tests (Kruskall-Wallis) indicated that Salt-Desert and Sage-Brush sites did not differ from each other, nor Mixed Mountain Shrub and Pinon-Juniper from each other. Results indicate that all members of these two groups differed across them, e.g. Sage-brush differed from both Mixed Mountain Shrub and Pinon-Juniper and *vice versa*.  The two lower elevation strata, Salt Desert and Sage Brush, are generally more accessible to humans and have higher recreational land uses, and had the lowest C-Vals. While the values did vary, the extent of the variation was minor, with the range of variation from the median values `r my_range(fqa_meds, 'med_C')` and a mean range of `r my_range(fqa_meds, 'mean_C')`, given that the these values occur over a range of 0-10, we considered this to be a negligible difference, not indicative of major biases in the C-values ascribed to plants themselves, but rather indicative of actual land conditions. 



\newpage

### Appendix A - Indices

Mean Coefficient of Conservatism: 
$$
\overline{C} = \frac{\sum{} C_i}{S}
$$

Where:  
\begin{enumerate}[nosep]
  \item[] $\overline{C}$ is the Mean Coefficient of Conservatism, or for short Mean C
  \item[] $S$ is the number of species included in the calculation  
  \item[] $C_i$ in particular $C$ is the Conservatism Value (C-Value), for each $_i$ of the $S$ at the site  
  \item[] $\sum{}$ is an operator, meaning that we will calculate the sum of all C-Values, $C$  
\end{enumerate}

Floristic Quality Index: 
$$
FQI = \overline{C} * \sqrt{S}
$$

Where:  
\begin{enumerate}[nosep]
  \item[] $\overline{C}$ is the Mean Coefficient of Conservatism, or for short Mean C  
  \item[] $\sqrt{S}$ is the square root of the number of species included in the calculation  
\end{enumerate}

Equations from @swink1994plants, and modified for simpler formulations. 


\newpage

# References

 
