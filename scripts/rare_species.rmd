---
title: "Rare Species"
author: NULL
date: NULL
output:
  pdf_document: default
  word_document: default
header-includes: 
 - \usepackage[width=\textwidth]{caption}
 - \usepackage{amsmath, booktabs, caption, longtable}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

> _"Rarity is one of those concepts that suffuses our culture: it defies precise definition and when used by the scientist it is often given a spurious accuracy to satisfy our need for precision."_
>
> `r tufte::quote_footer('--- V.H. Heywood 1988')`

In general, a connotation where rare species are synonymous with legal protections exists in popular culture (@kruckeberg1985biological, @gaston1994rarity). However, rarity is the normal condition under which a vast multitude of species in all kingdoms of life exist, and only a subset of these species are at risk of extinction (@enquist2019commonness, @flather2007species). Rare species are inherently organisms which are difficult to detect in nature relative to other 'common' species (@rabinowitz1981seven), but see @kondratyeva2019reconciling for elaborations on rarity. One of the most consistently supported, both empirically and theoretically, observations in ecology is that the majority of species in any one location are represented by only a few individuals (@preston1948commonness, @stohlgren2005patterns, @manzitto2022most). 

Rare species encode enormous amounts of functional diversity to an area and have been shown in multiple cases to imbue an ability to respond to disturbance (@isbell2011high, @leitao2016rare, @mouillot2013rare, @oliver2015biodiversity). While we focus on large functional groups in SECTION XX, each of these groups has enormous variation within them, and due to the sheet number of rare species, they comprise most of the variation within these groups (@kondratyeva2019reconciling,  @mouillot2013rare). Rare species are also capable of reducing the possibility and severity of biological invasions (@lyons2001rare, @oakley2013plant). 

A popular conceptual framework to discuss these species may be considered which contains three dimensions, 1) the geographic expanse of the species, 2) their relative restriction to particular habitats, 3) and the number of individuals per population 'size' (@rabinowitz1981seven). Collectively the interaction between these traits can result in a matrix with eight cells along these axises (Table 1), seven of these cells being rare species, six of which occur more frequently (@rabinowitz1981seven). The rare species which receive most of the attention, are those which are restricted to particular habitats across narrow geographical extents, *'narrow (local) endemics'* (Table 1 & 2) (@kruckeberg1985biological). In general narrow endemics tend to be the species which require special legal protection to ensure their habitats undergo minimal alterations (@harnik2012long, AND AND ).  However, the remaining types of rarity still call for documentation by land management agencies. 

```{r Create Rabinowitz table, eval = F}
library(gt)

footnote = 'A typology of rare species based on three characteristics: geographic range, habitat specificity, and local population size.'

rabinowitz <- data.frame(
  rowname = c('Large, dominant somewhere', 'Small, non-dominant'),
  wide = c(
    'Locally abundant over large range in several habitats', 
    'Constantly sparse over large range in several habitats'), 
  narrow = c(
    'Locally abundant over large range in a specific habitat',
    'Consistently sparse in a specific habitat but over a large range'),
  wide1 = c(
    'Locally abundant in several habitats but restricted geographically',
    'Constantly sparse and geographically restricted in several habitats'),
  narrow1 = c(
    'Locally abundant in a specific habitat but restricted geographically',
    'Constantly sparse and geographically restricted in a specific habitat')
  )

rab_tab <- rabinowitz %>% 
  gt(rowname_col = "rowname") %>% 
  fmt_markdown(columns = everything()) %>% 
  tab_header(
      title = 'Seven Forms of Rarity',
      subtitle = 'From Rabinowitz 1981') %>% 
  cols_align(align = "center" ) %>% 
  cols_label(
      wide = "Wide",
      narrow = "Narrow",
      wide1 = "Wide",
      narrow1 = "Narrow") %>% 
  tab_spanner(
    id = 'test',
    label = 'Large',
    columns = c(wide, narrow)) %>% 
  tab_spanner(
    label = 'Small',
    columns = c(wide1, narrow1)) %>% 
  tab_stubhead('Geo. Range: Habitat:') %>% 
  tab_row_group(
    label = 'Population Size', 
    rows  = 1:2) %>% 
  tab_footnote(footnote) %>% 
  
  tab_options(heading.background.color = "#FFE6E9",
              row_group.border.top.color = "white", #e6fffc # maybe for the remaining lines?
              heading.border.lr.color='white', 
              column_labels.border.top.color = "white",
              table.border.top.color = "white",
              table.border.bottom.color = "white",
              table_body.hlines.color = "white",
              heading.padding = 0,
              row_group.padding = 0)

gtsave(rab_tab, "../results/rab_tab.png")

rabinowitz_examples <- data.frame(
  rowname = c('Large, dominant somewhere', 'Small, non-dominant'),
  wide = c(
    'Common', 
    'Draba oligosperma'), 
  narrow = c(
    'Camissonia eastwoodiae',
    'Cypripedium calceolus ssp. parviflorum'),
  wide1 = c(
    'Sclerocactus glaucus',
    ''),
  narrow1 = c(
    'Penstemon retorsus',
    'Eriogonum pelinophilum')
  )

rab_tab_examples <- rabinowitz_examples %>% 
  gt(rowname_col = "rowname") %>% 
  fmt_markdown(columns = everything()) %>% 
  tab_header(
      title = 'Seven Forms of Rarity',
      subtitle = 'From Rabinowitz 1981 - Species modified to Field Office') %>% 
  cols_align(align = "center" ) %>% 
  cols_label(
      wide = "Wide",
      narrow = "Narrow",
      wide1 = "Wide",
      narrow1 = "Narrow") %>% 
  tab_spanner(
    id = 'test',
    label = 'Large',
    columns = c(wide, narrow)) %>% 
  tab_spanner(
    label = 'Small',
    columns = c(wide1, narrow1)) %>% 
  tab_stubhead('Geo. Range: Habitat:') %>% 
  tab_row_group(
    label = 'Population Size', 
    rows  = 1:2) %>% 
  tab_footnote(footnote) %>% 
  tab_options(heading.background.color = "#e6fffc",
              row_group.border.top.color = "white", #e6fffc # maybe for the remaining lines?
              heading.border.lr.color='white', 
              column_labels.border.top.color = "white",
              table.border.top.color = "white",
              table.border.bottom.color = "white",
              table_body.hlines.color = "white",
              heading.padding = 0,
              row_group.padding = 0)

gtsave(rab_tab_examples, "../results/rab_tab_examples.png")
```


```{r Display Rabinowitz table }
knitr::include_graphics("../results/rab_tab.png")
```


> _"Many species are abundant in portions of their range, but uncommon in others @brown1995spatial, @ter2016discovery"_
> `r tufte::quote_footer('--- Enquist et al. 2021')`

Using the conceptual model in Figure 1 we see that a majority of species in the UFO field office which would be considered rare are likely to have 'Large' Geographic Ranges (left two columns, note the upper left most entry represents common species). These three cells of rare species are less likely to be have federal protections, although at the edges of their ranges may have state protections, as they fundamentally at lower risk of extinction (Figure 2) (@flather2007species). Biologically, these taxa may have interesting properties, relating to their relative positions in the range of the species distribution. As the land which the UFO administers represents only a subset of the range of variation which exists in Western Colorado. An obvious example is that we lack both alpine, and many types of forests. Accordingly, species which may be common on Forest Service Land, may be rare on UFO land. Naturally these species are not of concern for identifying lands which need enhanced protections as would be offered under regulatory protocols, but they provide opportunities for distributing reproductive material to adjacent sites.

In particular, they may be species which are at the edges of their distributions, populations of species at the edges of distributions - either geographically or climatically - these populations often have notably different genetic constitutions than populations near the centers (@hampe2005conserving, @oldfather2020range, reviewed in @PeclGrettaT2017Bruc). Populations which are expanding into new geographic ranges, largely following shifts in climates are termed *leading edges*, and those populations persisting at the edge of the extent geographic ranges are noted as *trailing edges*. Conserving trailing edge populations at the local level is important as they may contain many forms of genes which are pre-disposed to adapting to climate change associated variables (@hampe2005conserving). Further these populations may end up being essential for adaption on up-slope Forest Service Lands, where our border with them faces alterations associated with severe fires and which may require immediate seed sourcing to recover a stable state (@parks2019living). Theoretically the lowlands of the UFO are capable of receiving migrants to them from a *leading edge*, however the up slope travel required to enter the basins (e.g. Paradox), slows steady-state dispersal, reducing the chances of immigrants to relatively infrequent events, such as seeds being stuck to muddy bird feet (@nathan2008mechanisms, @jordano2017long). While these events have largely shaped the global distribution of biodiversity, their infrequent occurrence generally means they occur on timescales outside of land management (@nathan2008mechanisms). 

Recently approaches to develop a consensus index of Rabinowitzs sense of rarity exist (@maciel2020rare7, @maciel2021index). Here we attempt to leverage this index, along with another more traditional metric (@gaston1994rarity), to identify plants which are locally rare within the Field Offices administrative areas. 

```{r Display Rabinowitz table with examples}
knitr::include_graphics("../results/rab_tab_examples.png")
```

The other half of the table in Figure 1, the two right columns with 'Small' Geographic Ranges represents species which are very well tracked by multiple tiers of government and are generally of conservation concern. Species with 'Small' Geographic Ranges and 'Wide' Habitat Specificity (column 3) would be expected to be encountered at numerous AIM plots. These taxa are almost always generally noted as rare by the State, and BLM, and may be considered threatened or endangered by the United States Fish and Wildlife Service (USFWS), the agency which administers the *Endangered Species Act* (Figure 2); but tend to be quite abundant across the landscape within which they reside. Finally the column at right represents the species at the fundamental core of our notions of 'rarity'. These taxa are generally warranted legal protections as human modification of their habitats has the possibility to result in catastrophic declines of populations and subsequently the species. We will utilize pre-compiled tracking lists to address the species which aggregate in this end of the table. 

# Methods 

```{r install libraries, eval = F}
install.packages('BIEN')
```

```{r Load libraries}
library(tidyverse)
library(terra)
library(sf)
```


```{r Import AIM species richness}

praw <- '../data/raw'
ppro <- '../data/processed'
f <- list.files(praw)
files <- list.files(ppro, pattern = 'csv')

#richness <- read.csv(file.path(praw, f[grep('Associations', f)])) %>% 
#  filter(PHASE == '1.1', str_length(SYMBOL) >= 4)  

CO_plants <- read.csv(file.path(ppro, files[grep('Native', files)])) %>% 
  filter(NATIVITY == 'Native')

```


```{r Import tracked Plants}
tracked <- read.csv(file.path(ppro, files[grep('Rare_Plants_BLM', files)]))  
Nspp_trackedCO <- nrow(tracked)
Nspp_blmCO_tracked <- filter(tracked, BLM_RANK == T) %>% nrow()
```

To identify rare plants via the aggregated Rabinowitz method... the concepts of the Rare7 package were used. 


```{r Gather Plant Records, eval = F}
spp_v <- CO_plants$BINOMIAL_NAT
occurrences <- BIEN::BIEN_occurrence_species(spp_v)
write.csv( file.path( praw, 'BIEN_occurrences.csv'), row.names = F)
```

```{r Prune records to North America, eval = F}

l3eco <- vect(file.path(praw, 
                        list.files(praw, recursive = T, pattern = 'Level3.*shp$')
                        )) |> aggregate() |> simplifyGeom()  

e <- ext(l3eco)
l3eco_rast <- rast(
  resolution = 1000,
  ymin = e[3], ymax = e[4], xmin = e[1], xmax = e[2],
  crs = crs(l3eco))
l3eco_rast <- rasterize(l3eco, l3eco_rast, background = NA)

occurrences <- read.csv(file.path( praw, 'BIEN_occurrences.csv')) %>% 
  mutate(date_collected = as.Date(date_collected)) %>% 
  filter(date_collected > '1900-01-01') %>% 
  vect(geom=c("longitude", "latitude"), crs = "epsg:4269") 

l3eco_rast <- project(l3eco_rast, crs(occurrences))
occ_t <- extract(l3eco_rast, occurrences)

occurrences <- occurrences[!is.na(occ_t$layer),]
occurrences <- st_as_sf(occurrences)

output_dir <- file.path(ppro, 'occurrences' )
if (!dir.exists(output_dir)) {dir.create(output_dir)}
st_write(occurrences, file.path(output_dir, 'occurrences_NA.shp'), quiet = T)

rm(l3eco, e, occurrences, output_dir, occ_t)
```


#### Geographic Range - 

Convex hulls, the smallest area required to cover all locations on an attribute, were developed for each species to calculate the coarse range occupied by a taxon. From the convex hulls, 1km cells which contained over > 95% snow/ice, agricultural, and open water were removed from the hulls (@tuanmu2014global). In order to address *disjunct* distributions, these remaining convex hulls then had a grid created across them in the form of $\frac{No.Records}{16}$, each cell which had at least a single record located within it was kept, cells without species in them were disregarded. The total remaining cells in the this range constitute the total range of the species. After all species had these values calculated they were scaled within the range of 0-1, where larger values indicate larger ranges.

```{r Prepare exclusion surfaces for geographic range records, eval = F}
lc <- list.files(praw, pattern = 'tif', recursive = T)
lseco_83 <- project(l3eco_rast,  "epsg:4326")
lseco_83 <- trim(lseco_83)
e <- ext(lseco_83)

rm(lseco_83, l3eco_rast)

agriculture <- crop(rast(file.path(praw, lc[grep('Agri', lc)])), e )
water <- crop(rast(file.path(praw, lc[grep('Water', lc)])), e)
snow <- crop(rast(file.path(praw, lc[grep('Snow', lc)])), e)
urban <- crop(rast(file.path(praw, lc[grep('Urban', lc)])), e)

agriculture <- subst(agriculture, 0:50, NA)
water <- subst(water, 0:50, NA)
snow <- subst(snow, 0:50, NA)
urban <- subst(urban, 0:50, NA)

impervious_multiple <- mosaic(agriculture, water, snow, urban, fun = "sum", 
                              filename = file.path(ppro, 'impervious_surfaces.tif'),
                              overwrite = T)

rm(agriculture, water, snow,urban)

m <- c(0, 75, 0,
      75, 100, 1)
rclmat <- matrix(m, ncol=3, byrow=TRUE)
impervious_multiple <- classify(impervious_multiple, rclmat, include.lowest=TRUE)
impervious_multiple <- focal(impervious_multiple, w=9, max)

writeRaster(impervious_multiple, file.path(ppro, 'impervious_surfaces.tif'), overwrite = T)

rm(m, rclmat)
```


```{r Create convex Hulls}

occurrences <- st_read(file.path(ppro, 'occurrences' , 'occurrences_NA.shp'), quiet = T)

occsplit <- split(occurrences, occurrences$scrbb__)
ch <- lapply(occsplit, st_combine)
ch <- lapply(ch, st_convex_hull)

d <- ch[[1]]

ggplot() +
  geom_sf(data = d) +
  geom_sf(data = occsplit[[1]]) +
  theme_classic()

areas <- lapply(ch, st_area)
areas <- unlist(areas)
areas <- data.frame(Species = names(areas), 
                    km.Squared = round(as.numeric(areas)/1000000, 0) )


cellSize(impervious_multiple)

grid <- st_make_grid(
  occsplit[[30]],
  what = "polygons",
  square = TRUE
)


ggplot() +
  geom_sf(data = grid) +
  geom_sf(data = occsplit[[30]])


int <- grid[lengths(st_intersects(grid, occsplit[[30]])) >= 1 ]

ggplot() +
  geom_sf(data = int) +
  geom_sf(data = occsplit[[30]])


rm(occsplit)
```

#### Habitat Range -

To produce a proxy for the variations of habitats which a species may be found in Omernik level IV and III ecoregions were used. Spatial products for the level IV ecoregions 'subdistricts', the finest resolution product, exists for the entirety of the conterminous United States. Spatial products for the level III ecoregions exist for Canada, Mexico, and the United States, these products were mosaiced together, with the higher resolution subdistricts overwriting the level 3 data where available. 

They had Omernik regions extracted to the points, and the proportion of habitats were calculated,  $1 -  NumberHabitats/NumberPoints  $, these were then rescaled to maximize the variance between 0 and 1, species across more habitats had values closer to 1, while species in fewer habitats had scores closer to 0.

```{r Rasterify habitat Ranges and extract to point, eval = F}

l4eco <- vect(file.path(praw, list.files(praw, recursive = T, pattern = 'l4.*shp$')))
l3eco <- vect(file.path(praw, list.files(praw, recursive = T, pattern = 'Level3.*shp$')))
l4eco <- project(l4eco, crs(l3eco))

e <- ext(l3eco)
l4eco_rast <- rast(
  resolution = 1000,
  ymin = e[3], ymax = e[4], xmin = e[1], xmax = e[2],
  crs = crs(l4eco))
l4eco_rast <- rasterize(l4eco, l4eco_rast, field = 'US_L4CODE', background = NA)

l3eco_rast <- rast(
  resolution = 1000,
  ymin = e[3], ymax = e[4], xmin = e[1], xmax = e[2],
  crs = crs(l3eco))
l3eco_rast <- rasterize(l3eco, l3eco_rast, field = 'NA_L3CODE', background = NA)

l3eco_rast <- mask(l3eco_rast, l4eco_rast, inverse  = T, updatevalue = NA )
eco <- mosaic(l3eco_rast, l4eco_rast)

writeRaster(eco, file.path(ppro, 'EcoRegionsCombined.tif'))

rm(l4eco, l3eco, e, eco, l3eco_rast, l4eco_rast)
```

#### Population Size -

To create a relatively consistent estimate of population size the % cover of LPI points for forbs were regressed against estimates of the # of individuals from species richness. The slopes of these regressions were then used to calculate a percent cover estimate for the taxon. Given the relatively low density placement of aim points along transects these were considered indepdenent (i.e. each point drop represents a distinct plant) for all life forms except for trees, which had this value recorded. 


#### Correlations 

Due to the range in habitats, as proxied by the Ecoregions, being inherently correlated with the geographic range of a species we sought to combine them into a single predictor. 

the correlation of geographic range to habitat range was checked with linear regression. These two values were then reconstituted to form a single variable via GR * HR. OR PCA...


```{r Gather Species Records from BIEN for Range Descriptions}



```

```{r Import ESG classifications of plots for habitat diversity}

```

```{r Calculate the Rabinowitz consensus of rarity}

```

```{r plot all aim species}

```



To identify the number of rare plants under Gastons quantile. 

```{r Identify tracked Plants found on AIM plots}

```

```{r Calculate Gastons rarity}

```

```{r Identify Single and doubleton incidences}

```


# Results 

As of 2022, the Colorado Natural Heritage Program noted entries for the tracking of `r Nspp_trackedCO` Vascular *taxa* of plants. Of these species `r` are known from the general area of the UFO, and `r` have been documented on UFO administered land. AIM crews observed the presence of `r` of these taxa, at `r` AIM sites. `r` of these sightings served as revisits to known *elemental occurrences* (EO's) and serve to document that the taxon was still extent in an established EO. `r` of these sightings, for `r` taxa, qualified as new *EOs* - or at least finally provide the essential official written documentation of a population. For the first time ever, AIM crews documented the existence of `r` species on UFO BLM administered lands.

The CNHP rankings include many species which are considered rare by agencies with different focuses and intentions from the BLM. While their initial list is comprised of `r Nplants_trackedCO` the Bureau of Land Management Sensitive Species for Colorado has `r Nspp_blmCO_tracked` species. The discrepancy in number arising largely from a BLM not including taxa which do not grow on the lands, as well as contextualizing these taxa in the west *ask ken how they actually do this - i made up this whole sentence*.  Of these species `r` are known from the general area of the UFO, and `r` have been documented on UFO administered land. AIM crews observed the presence of `r` of these taxa, at `r` AIM sites. `r` of these sightings served as revisits to known *elemental occurrences* (EO's) and serve to document that the taxon was still extent in an established EO. `r` of these sightings, for `r` taxa, qualified as new *EOs* - or at least finally provide the essential official written documentation of a population. For the first time ever, AIM crews documented the existence of `r` species on UFO BLM administered lands.

When we remove these `r` known and documented, by CNHP, rare species from the subsequent analyses of rarity, the use of the composite Rabinowitzs Index identifies `r` taxa as rare. To determine whether this metric was capable of detecting species which have been identified as rare by the CNHP, the list of species ... was compared to the output from the function ... and chi-square results SAY ... Indicating that...


Using Gastons Quantile definition `r` taxa, or % remaining species,  are identified as rare. 


# Discussion


\newpage

# References

