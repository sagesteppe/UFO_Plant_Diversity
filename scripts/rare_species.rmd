---
title: "Rare Species"
knit: (function(inputFile, encoding) 
  { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'Section_13.pdf')) })
output:
  pdf_document: default
  word_document: default
header-includes:
- \usepackage[width=\textwidth]{caption}
- \usepackage{wrapfig}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

\pagenumbering{gobble}
\vspace{-1cm}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

> _"Rarity is one of those concepts that suffuses our culture: it defies precise definition and when used by the scientist it is often given a spurious accuracy to satisfy our need for precision."_
>
> `r tufte::quote_footer('--- V.H. Heywood 1988')`

A connotation where rare species are synonymous with legal protections exists in popular culture (@kruckeberg1985biological, @gaston1994rarity). However, rarity is the normal condition under which an enormous amount, if not the majority, of species in all kingdoms of life exist, and only a subset of these species are at risk of extinction (@enquist2019commonness, @flather2007species). By definition rare species are organisms which are inherently difficult to detect in nature relative to 'common' species (@rabinowitz1981seven), but see @kondratyeva2019reconciling for elaborations on rarity. One of the most consistently supported observations in ecology, both empirically and theoretically, is that the majority of species in any one location are represented by only a few individuals (@preston1948commonness, @stohlgren2005patterns, @manzitto2022most). 

Rare species encode enormous amounts of functional diversity to an area and have been shown in multiple cases to imbue an ability for areas to respond to disturbance (@isbell2011high, @leitao2016rare, @mouillot2013rare, @oliver2015biodiversity). While we focus on large functional groups in Sections 11 & 12, each of these groups has enormous variation within them, and due to the sheer number of rare species, they comprise most of the variation within these groups (@kondratyeva2019reconciling,  @mouillot2013rare). In addition to allowing areas to respond to disturbance, they are also capable of reducing the possibility and severity of biological invasions (@lyons2001rare, @oakley2013plant). 

A popular conceptual framework to discuss rare species may be considered which contains three dimensions, 1) the geographic expanse of the species, 2) their relative restriction to particular habitats, 3) and the number of individuals per population - 'size' (@rabinowitz1981seven). Collectively the interaction between these traits can result in a matrix with eight cells along three axis (Table 1). Seven of these cells represent traits associated with rare species, six of which frequently occur, and one which is seldom -if ever- observed (@rabinowitz1981seven). The rare species which receive most of the attention, are those which are restricted to particular habitats across narrow geographical extents, *'narrow (local) endemics'* (Table 1 & 2) (@kruckeberg1985biological). In general narrow endemics tend to be the species which require special designations to ensure their habitats undergo minimal alterations (@harnik2012long).  However, the remaining types of rarity still call for documentation by land management agencies. 

```{r Create Rabinowitz table, eval = F}
library(gt)
library(tidyverse)

footnote = 'A typology of rare species based on three characteristics: geographic range, habitat specificity, and local population size.'

rabinowitz <- data.frame(
  rowname = c('Large, dominant somewhere', 'Small, non-dominant'),
  wide = c(
    'Locally abundant over large range in several habitats', 
    'Constantly sparse over large range in several habitats'), 
  narrow = c(
    'Locally abundant over large range in a specific habitat',
    'Consistently sparse in a specific habitat but over a large range'),
  wide1 = c(
    'Locally abundant in several habitats but restricted geographically',
    'Constantly sparse and geographically restricted in several habitats'),
  narrow1 = c(
    'Locally abundant in a specific habitat but restricted geographically',
    'Constantly sparse and geographically restricted in a specific habitat')
  )

rab_tab <- rabinowitz %>% 
  gt(rowname_col = "rowname") %>% 
  fmt_markdown(columns = everything()) %>% 
  tab_header(
      title = 'Seven Forms of Rarity',
      subtitle = 'From Rabinowitz 1981') %>% 
  cols_align(align = "center" ) %>% 
  cols_label(
      wide = "Wide",
      narrow = "Narrow",
      wide1 = "Wide",
      narrow1 = "Narrow") %>% 
  tab_spanner(
    id = 'test',
    label = 'Large',
    columns = c(wide, narrow)) %>% 
  tab_spanner(
    label = 'Small',
    columns = c(wide1, narrow1)) %>% 
  tab_stubhead('Geo. Range: Habitat:') %>% 
  tab_row_group(
    label = 'Population Size', 
    rows  = 1:2) %>% 
  tab_footnote(footnote) %>% 
  
  tab_options(heading.background.color = "#FFE6E9",
              row_group.border.top.color = "white", #e6fffc # maybe for the remaining lines?
              heading.border.lr.color='white', 
              column_labels.border.top.color = "white",
              table.border.top.color = "white",
              table.border.bottom.color = "white",
              table_body.hlines.color = "white",
              heading.padding = 0,
              row_group.padding = 0)

gtsave(rab_tab, "../results/rab_tab.png")

rabinowitz_examples <- data.frame(
  rowname = c('Large, dominant somewhere', 'Small, non-dominant'),
  wide = c(
    'Common', 
    md('*Draba oligosperma*') ), 
  narrow = c(
    md('*Camissonia eastwoodiae*'),
    md('*Cypripedium calceolus* ssp. *parviflorum*') ),
  wide1 = c(
    md('*Sclerocactus glaucus*'),
    '') ,
  narrow1 = c(
    md('*Pediomelum aromaticum*'),
    md('*Eriogonum pelinophilum*')
  )
)

rab_tab_examples <- rabinowitz_examples %>% 
  gt(rowname_col = "rowname") %>% 
  fmt_markdown(columns = everything()) %>% 
  tab_header(
      title = 'Seven Forms of Rarity',
      subtitle = 'From Rabinowitz 1981 - Species modified to Field Office') %>% 
  cols_align(align = "center" ) %>% 
  cols_label(
      wide = "Wide",
      narrow = "Narrow",
      wide1 = "Wide",
      narrow1 = "Narrow") %>% 
  tab_spanner(
    id = 'test',
    label = 'Large',
    columns = c(wide, narrow)) %>% 
  tab_spanner(
    label = 'Small',
    columns = c(wide1, narrow1)) %>% 
  tab_stubhead('Geo. Range: Habitat:') %>% 
  tab_row_group(
    label = 'Population Size', 
    rows  = 1:2) %>% 
  tab_footnote(footnote) %>% 
  tab_options(heading.background.color = "#e6fffc",
              row_group.border.top.color = "white", #e6fffc # maybe for the remaining lines?
              heading.border.lr.color='white', 
              column_labels.border.top.color = "white",
              table.border.top.color = "white",
              table.border.bottom.color = "white",
              table_body.hlines.color = "white",
              heading.padding = 0,
              row_group.padding = 0) 

gtsave(rab_tab_examples, "../results/rab_tab_examples.png")
```

\begin{table}[ht]
\caption{Conceptual forms of Rarity} 
\includegraphics[width=1\textwidth]{../results/rab_tab.png}
\end{table}

\newpage

> _"Many species are abundant in portions of their range, but uncommon in others @brown1995spatial, @ter2016discovery"_
> `r tufte::quote_footer('--- Enquist et al. 2021')`

Considering the conceptual model in Table 1 we see that a majority of species in the Uncompahgre Field Office which would be considered rare are likely to have 'Large' Geographic Ranges (left two columns, note the upper left most entry represents common species). That most rare species have large geographic ranges seems to the typical condition in temperate regions. 

These three cells of rare species are less likely to be have special designations (ESA, SSS) because as a species they are fundamentally at lower risk of extinction due to the decreased likelihood of all populations going extinct via the same causes (Table 2) (@flather2007species). However, at edges of there geographic ranges these species are likely to have state protections, because the species may lose the few populations (local extinction) which exist in those administrative units. Biologically, these widespread rare taxa may have interesting properties, relating to their relative positions in the range of the species distribution.

In particular, these common rare species, especially when at the edges of their distributions, either geographically or climatically - often have populations which have notably different genetic constitutions than populations near the centers (@hampe2005conserving, @oldfather2020range, reviewed in @PeclGrettaT2017Bruc). Populations which are expanding into new geographic ranges, largely following shifts in climates are termed *leading edges*, and those populations persisting at the edge of the extent geographic ranges are noted as *trailing edges*. Conserving trailing edge populations at the local level is important as they may contain many forms of genes which are pre-disposed to adapting to climate change (@hampe2005conserving). Further these populations may end up being essential for adaption on up-slope Forest Service Lands, where our border with them faces alterations associated with severe fires and which may require immediate seed sourcing to recover a stable state (@parks2019living). Theoretically the lowlands of the UFO are capable of receiving migrants to them from a *leading edge*, however the up slope travel required to enter the basins (e.g. the Paradox Valley), slows steady-state dispersal, reducing the chances of immigrants to relatively infrequent events, such as seeds being stuck to muddy bird feet (@nathan2008mechanisms, @jordano2017long). While these events have largely shaped the global distribution of biodiversity, their infrequent occurrence generally means they occur on timescales outside of land management considerations (@nathan2008mechanisms). However, that many species which are in the field office via long-distance dispersal, but which are currently uncommon, but may greatly expand under climate change is probable.

\begin{table}[ht]
\caption{Local Examples of Rarity} 
\includegraphics[width=1\textwidth]{../results/rab_tab_examples.png}
\end{table}

The other half of the Table 1, the two right columns with 'Small' Geographic Ranges represents species which are very well tracked by entities and are generally of conservation concern. Species with 'Small' Geographic Ranges and 'Wide' Habitat Specificity (column 3) would be expected to be encountered at numerous AIM plots. These taxa are almost always generally noted as rare by the State, and BLM, and may be considered threatened or endangered by the United States Fish and Wildlife Service (USFWS), the agency which administers the *Endangered Species Act* (Table 2); but tend to be quite abundant across the landscape within which they reside. Finally the column at right represents the species at the fundamental core of our notions of 'rarity'. These taxa are generally warranted legal protections as human modification of their habitats has the possibility to result in catastrophic declines of populations and subsequently the species. We will utilize pre-compiled tracking lists, from the Endandered Species Act, BLM Sensitive Species, and NatureServe, to address the species which aggregate in this end of the table. 

In this section we seek to identify all rare species of conservation concern. We identify all singleton species, those encountered only once, as well as all records under the 25th quantile (@gaston1994rarity) of observations, to identify plants which are locally rare within the Field Offices administrative areas. We use a variety of Governmental and Non-Governmental datasets to identify the rare species of conservation concern which were encountered throughout the field office. 

## Methods 

```{r Load libraries}
library(tidyverse)
library(terra)
library(sf)
source('functions.R')
```

```{r Import AIM species richness}

praw <- '../data/raw'
ppro <- '../data/processed'
f <- list.files(praw)
files <- list.files(ppro, pattern = 'csv')

spp_richness <- read.csv(file.path(praw, f[grep('SpeciesRichness[.]', f)])) %>% 
  select(SpeciesList, PrimaryKey)
spp_r_header <- read.csv(file.path(praw, f[grep('RichnessHeader', f)])) %>% 
  select(FormDate, Observer, PrimaryKey)

pts <- st_read(
  '../../aimDB/data/raw/AIM_Sample_Design/AIM_Design_Stratification.shp',
                quiet = T) %>% 
  st_transform(26913) %>% 
  st_buffer(65) %>% 
  select(PLOTID, STRATUM) 

char <- read.csv(file.path(praw, f[grep('Characterization', f)] ) ) %>% 
  st_as_sf( coords = c('Longitude', 'Latitude'), crs = 4269) %>% 
  filter(str_detect(PrimaryKey, negate = T,
                    'Fuels|Bull-Draw|CO-NWD|_Tres_Rios|Grand_Junction|Gunnison|Moab|TRFO'),
         str_detect(PlotID, '[A-Z]{2,3}-[0-9]{2,3}')) %>% 
  st_transform(26913) %>% 
  select(PrimaryKey) 

spp_richness <- st_intersection(pts, char)  %>% 
  left_join(., spp_r_header, by = 'PrimaryKey') %>% 
  left_join(., spp_richness, by = 'PrimaryKey') %>% 
  rename(SYMBOL_AIM = SpeciesList) 

no_records_full <- nrow(spp_richness)

rm(pts, char, spp_r_header)
```

```{r minor cleaning species richness}

# remove unknowns here, only 118 records total across 5 years, pretty impressive!
unks <- spp_richness %>% 
  filter(str_detect(SYMBOL_AIM, '^AG|^PG|^AF|^PF|^SH\\d+')) %>%
  nrow()

spp_richness <- spp_richness %>% 
  filter(str_detect(SYMBOL_AIM, '^AG|^PG|^AF|^PF|^SH\\d+', negate = T))

# add on the official USDA codes to the AIM codes to sync up with CNHP
attributes <- read.csv(
  file.path(ppro, files[grep('Attribute.*Table-RCB', files)]) ) %>% 
  select(SYMBOL_AIM, SYMBOL_USDA) %>% 
  distinct() # one duplicate in here somewhere!

spp_clean <- left_join(spp_richness, attributes, by = 'SYMBOL_AIM') 
  
# join all CNHP to ensure all of our records are a clean map
CO_plants <- read.csv(file.path(ppro, files[grep('Native', files)]))

spp_clean_1 <- spp_clean %>% 
  filter(is.na(SYMBOL_USDA)) %>% 
  left_join(., CO_plants, by = c('SYMBOL_AIM' = 'SYMBOL')) %>% 
  mutate(SYMBOL_USDA = SYMBOL_AIM)

spp_dirty <- spp_clean_1  %>% 
  filter(is.na(BINOMIAL_NAT)) %>% 
  filter(str_detect(SYMBOL_AIM, 'UN.*', negate = T)) %>% 
  count(SYMBOL_AIM) #  we now know how many records we lost to analysis here

spp_clean <- bind_rows(drop_na(spp_clean, SYMBOL_USDA), spp_clean_1) 
# we will use this dataset going foward,

n_w_syn <- nrow(spp_clean)

spp_clean <- spp_clean %>%  # NO SYNONYMS
  group_by(PLOTID, SYMBOL_USDA) %>% 
  distinct()

rm(spp_clean_1, attributes)
```

```{r Import tracked Plants}
tracked <- read.csv(file.path(ppro, files[grep('Rare_Plants_BLM', files)]))  
```

\begin{wrapfigure}{l}{0.3\textwidth}
  \centering
    \includegraphics[width=0.3\textwidth]{../plots/graphics/quint_single.png}
  \caption{The Commonness of Rarity; This plot shows the number of times which a species was encountered at an AIM Plot. Both the 'singletons' and Gastons Quintile are on the red line. A randomly selected subset of more abundant species are selected to contextualize the few abundant species}
\end{wrapfigure}\leavevmode

### Rare Species of Known Conservation Concern

To identify species which are rare, and are species of conservation concern, the Colorado Natural Heritage Program (CNHP) registry of rare plants was downloaded directly from the website in Winter of 2023. Using the list of C-values, also from the CNHP website, which contained an entry for nearly every species in the state (less *Mentzelia paradoxensis*), we determined the appropriate mapping between the plant species symbol used in the AIM database, and the official USDA codes used in all CNHP work. The CNHP registry of rare plants was then subset and used as the definitive source for each organizations tracked species. 

```{r Endangered Species Act}
esa <- tracked %>% drop_na(USESA)

fws_esa <- spp_clean %>% filter(SYMBOL_USDA %in% esa$National_USDASymbol)
# NO FALSE POSITIVES ALL CLEAN
```

```{r Bureau of Land Management Sensitive Species}
blm <- tracked %>% 
  filter(BLM_RANK == T) %>% 
  mutate(National_USDASymbol = case_when(
   GNAME == 'Mentzelia rhizomata' ~ 'Mentzelia rhizomata',
   GNAME == 'Oreocarya revealii' ~ 'CRGY',
   GNAME == 'Physaria pulvinata' ~ 'Physaria pulvinata',
   TRUE ~ National_USDASymbol
  ))

## POSSIBLE  FALSE POSITIVE Astragalus musiniensis 
blm_ss <- spp_clean %>% 
  filter(SYMBOL_USDA %in% blm$National_USDASymbol, SYMBOL_USDA != 'ASMU3') %>% 
  mutate(BINOMIAL_NAT =
           if_else(SYMBOL_USDA == 'PEAR7', '*Pediomelum aromaticum*',
                   paste0('*', BINOMIAL_NAT, '*'))) 
  
```

```{r NatureServe Rare Species}
fed <- c(blm$GNAME, esa$GNAME)
```

```{r NatureServe global}
global <- tracked %>% filter(str_detect(GRANK, 'G1|G2|G3'))
global_sub <- filter(global, !GNAME %in% fed)

global_aim <- spp_clean %>% filter(SYMBOL_USDA %in% global_sub$National_USDASymbol)

# FALSE POSITIVES # PHBE2
# WARRANT FURTHER STUDY Erigeron nematophyllus, Draba rectrifructa, Polypodium saximontanum, 
# Townsendia glabella

```

```{r NatureServe state}
state <- tracked %>% filter(str_detect(SRANK, 'S1|S2|S3'))
state_sub <- filter(state, !GNAME %in% fed)
state_sub1 <- filter(state_sub, !GNAME %in% global_sub$GNAME)

state_aim <- spp_clean %>% filter(SYMBOL_USDA %in% state_sub$National_USDASymbol)
```

### Rare but untracked Species

```{r Mentzelia gyposphila}

m_gyp <- spp_clean %>% 
  filter(PLOTID == 'OT-126' & SYMBOL_AIM == 'METH') %>% 
  mutate(SYMBOL_AIM = 'Mentzelia gypsophila',
         SYMBOL_USDA = 'Mentzelia gypsophila') 
meth <- spp_clean %>% 
  filter(SYMBOL_AIM == 'METH' & PLOTID != 'OT-126' ) 

spp_clean <- spp_clean %>% 
  filter(SYMBOL_AIM != 'METH') %>% 
  bind_rows(m_gyp, meth, .)


rm(m_gyp, meth)
```

```{r Indentification of Singletons}

records <- spp_clean %>% 
  group_by(SYMBOL_USDA) %>% 
  count()

singletons <- filter(records, n < 2)
```

```{r Calculate Gastons rarity}

gastons <- records %>% 
  st_drop_geometry() 

gastons <- gastons %>% # note gastons is the same as Singletons here! 
  mutate(qu25 = quantile(n, probs = c(0.25)))

gastons_rare <- gastons %>% 
  filter(n == qu25) 
```

```{r Plot Singletons and Gastons Quintile, eval = F}

abundant_species <- gastons %>% 
  filter(n > 50) %>% 
  slice_sample(n = 24, weight_by = n) %>% 
  arrange(n) %>% 
  mutate(y = rep(seq(from = 25, to = 200, by = 25), nrow(.)/8))

hl <- data.frame(yint = 1)

df2 <- expand.grid(
  lineend = c('round', 'butt', 'square'),
  linejoin = c('round', 'mitre', 'bevel'),
  stringsAsFactors = FALSE
)

quint_single <- ggplot(gastons, aes(y = n)) +
  geom_histogram(fill = 'grey20', bins = 198) +
  geom_hline(data = hl, aes(yintercept = yint),
             color = 'red', lty = 2, show_guide = T)+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        aspect.ratio=16/9) +
  labs(y = 'Number of Species', x = 'Number of Plots', 
       title = 'Species Occurrences') +
  geom_text(data = abundant_species, aes(y = n, x = y, label = SYMBOL_USDA),
            check_overlap = T, size = 2.5) +
  geom_segment(
    aes(xend = 233, yend = 5, x = 195, y = 25), 
    color = 'forestgreen',
     lineend = df2$lineend, linejoin = df2$linejoin,
     size = 0.8, arrow = arrow(length = unit(0.6, "lines"))
  )

quint_single

ggsave(plot = quint_single, device = 'png', height = 9, units = 'cm', 
       path = '../plots/graphics', filename = 'quint_single.png')

rm(hl, quint_single, abundant_species)
```

The number of plots which a species was recorded at were counted. This list was filtered for species which only occurred at a single plot, our ecological version of the botanical 'singletons' collection. This list also had the 25^th^ quantile calculated on it using the 'quantile' function from base R.

```{r install gbif, eval = F}
install.packages("rgbif")
user <- "steppe" # your gbif.org username 
pwd <- "blmquery" # your gbif.org password # this one is now old and serves as an example
email <- "reedbenkendorf27@gmail.com" # your email 
```


```{r Gather Plant Records I}
set.seed(1989)
co_nat <- CO_plants %>% filter(NATIVITY == 'Native')
ss <- 750
ss_perc <- paste0(round((ss / length(unique(co_nat$BINOMIAL_NAT))) * 100, 1), '%')
```

```{r Prepare GBIF queries, eval = F}
library(rgbif)

spp_v <- sample(unique(co_nat$BINOMIAL_NAT), ss)

gbif_taxon_keys <- spp_v %>% 
  name_backbone_checklist()  %>% 
  filter(!matchType == "NONE") %>% 
  pull(usageKey)
gbif_taxon_keys

dl_key <- occ_download(
  pred_in("taxonKey", gbif_taxon_keys),
  user=user, pwd=pwd, email=email,
  pred("country", "US"),
  pred("hasCoordinate", TRUE),
  pred("hasGeospatialIssue", FALSE),
  pred_gte("year", 1900)
)

d <- occ_download_get( dl_key ) %>%
    occ_download_import()

# these data were then downloaded via the GUI to a folder on lightscape and
# copied over onto the drive. 
# The column fields do not match very well, and you may need to load it in a
# spreadsheet manager such as the open source (free) libre calc

```

```{r Subset GBIF records of non target species, eval = F}

# step 1 only grab records not already downloaded in the last query
spp_occ <- data.table::fread(
  file.path( praw, 'GBIF_Query_Random/occurrence.txt'),
  sep="\t",  header=TRUE, stringsAsFactors=FALSE, quote=""
  )[, c('gbifID', 'publisher', 'basisOfRecord', 'recordedBy', 
        'recordNumber', 'occurrenceStatus', 'month', 
        'day', 'year', 'continent', 'decimalLatitude', 'decimalLongitude', 
        'coordinateUncertaintyInMeters', 'taxonID', 'acceptedNameUsageID',
        'acceptedScientificName', 'order', 'family', 'genus', 'species', 'specificEpithet',
        'infraspecificEpithet', 'acceptedTaxonKey', 'taxonRank', 'verbatimScientificName'
        )]

spp_occ <- spp_occ[occurrenceStatus == 'PRESENT', ][year >= 1900, ][coordinateUncertaintyInMeters < 10000,][continent != 'OCEANIA',]
spp_occ[spp_occ==''|spp_occ==' ']<-NA
spp_occ <- na.omit(spp_occ, cols = 'specificEpithet') %>% 
  distinct(decimalLongitude, decimalLatitude, species, .keep_all = TRUE)

# filter for species actually in Colorado, the DB has some slippage on queries 
# I cannot figure out, and alot of the synonyms are unrecoverable

target_binom <- unique(c(CO_plants$BINOMIAL_ACKER, CO_plants$BINOMIAL_NAT))
spp_occ <- spp_occ %>% 
  filter(species %in% target_binom)

spp_occ_large <- spp_occ %>%
  group_by(acceptedTaxonKey) %>% 
  filter(n() > 2500) %>% 
  slice_sample(n = 2500)
spp_occ <- spp_occ %>%
  group_by(acceptedTaxonKey) %>% 
  filter(n() < 2500) %>% 
  bind_rows(., spp_occ_large)

write.csv(spp_occ, file.path(praw, 'GBIF_Query_Random/occurrence_sub.txt'), row.names = F)

rm(target_binom, spp_occ_large)
```

```{r Gather Focal Plant Records - First Pass, eval = F}


focal <- data.table::fread(file.path(praw, 'GBIF_Query_Random/occurrence_sub.txt')) 
focal <- unique(focal, by = 'acceptedTaxonKey')

target_binom <- unique(c(CO_plants$BINOMIAL_ACKER, CO_plants$BINOMIAL_NAT))

all_species_UFO <- left_join(records, CO_plants,
                             by = c('SYMBOL_USDA' = 'SYMBOL')) %>% 
  pull() ############### here need to remove already found records from here...



spp2query_bien <- spp_clean %>% 
  distinct(SYMBOL_USDA) %>% 
  left_join(., CO_plants,  by = c('SYMBOL_USDA' =  'SYMBOL')) %>% 
  filter(!SYMBOL_USDA %in% spp_occ) %>% 
  drop_na(BINOMIAL_NAT) %>% 
  pull(BINOMIAL_NAT)

focal_occurrences <- BIEN::BIEN_occurrence_species(
  spp2query_bien, political.boundaries = F, new.world = T)

focal_occurrences <- focal_occurrences %>% 
  mutate(date_collected = as.Date(date_collected)) %>% 
  filter(date_collected > '1900-01-01') %>% 
  drop_na(latitude) %>% 
  drop_na(longitude) %>% 
  select(-datasource_id, -collection_code, -is_new_world)

write.csv(focal_occurrences, 
          file.path(praw, 'BIEN_focal_occurrences.csv'), row.names = F)
```

```{r Gather Focal Plant Records - Second Pass, eval = F}

focal <- read.csv(file.path(praw, 'BIEN_focal_occurrences.csv')) %>% 
  distinct(scrubbed_species_binomial)  %>% 
  pull(scrubbed_species_binomial)
  
spp2query_bien <- spp_clean %>% 
  distinct(SYMBOL_USDA) %>% 
  left_join(., CO_plants,  by = c('SYMBOL_USDA' =  'SYMBOL')) %>% 
  filter(!SYMBOL_USDA %in% spp_occ) %>% 
  drop_na(BINOMIAL_NAT) %>% 
  pull(BINOMIAL_NAT)

not_found <-  spp2query_bien[!spp2query_bien %in% focal] # these were not found
not_found

focal

```

```{r Calculate total geographic expanse - reference, eval = F}

occurrences <- read.csv(file.path( praw, 'BIEN_occurrences.csv'))

occurrences_l <- occurrences %>% 
  drop_na(longitude) %>% 
  drop_na(latitude) %>% 
  st_as_sf(coords = c(x = 'longitude', y = 'latitude'), crs = 4326) %>% 
#  group_by(scrubbed_species_binomial) %>% 
#  filter(n() > 2) %>% 
#  ungroup() %>% 
  split(., f = .$scrubbed_species_binomial)

start <- Sys.time()
occurrences_ch <- lapply(occurrences_l, convex_hull_resample) 
end <- Sys.time()
end - start

occurrences_geographic <- bind_rows(occurrences_ch)
write.csv(occurrences_geographic, file.path(praw, 'reference_occurrence_geographic_size.csv'))

rm(occurrences_l, occurrences_ch, occurrences)
```

```{r Calculate total geographic expanse - UFO, eval = F}

focal_occurrences <- read.csv(file.path(praw, 'BIEN_focal_occurrences.csv'))

focal_occurrences_l <- focal_occurrences %>% 
  st_as_sf(coords = c(x = 'longitude', y = 'latitude'), crs = 4326) %>% 
  split(., f = .$scrubbed_species_binomial )

occurrences_ch <- lapply(focal_occurrences_l, convex_hull_resample)
occurrences_geographic <- bind_rows(occurrences_ch)

write.csv(occurrences_geographic, 
          file.path(praw, 'focal_occurrence_geographic_size.csv'))

rm(focal_occurrences, focal_occurrences_l, occurrences_ch, occurrences_geographic)
```

```{r}
rm(co_nat, ss)
```

```{r Prepare exclusion surfaces for geographic range records, eval = F}

r <- list.files(file.path(praw, 'landcover'))
rast_ext <- ext(-170, -30, 20, 80)

ag <- rast(file.path(praw, 'landcover', r[grep('Agriculture', r)]))
water <- rast(file.path(praw, 'landcover', r[grep('OpenWater', r)]))
snow <- rast(file.path(praw, 'landcover', r[grep('SnowIce', r)]))
urban <- rast(file.path(praw, 'landcover', r[grep('Urban', r)]))

impervious <- sum(ag, water, snow, urban)
impervious <- crop(impervious, rast_ext)
impervious <- classify(impervious, c(0, 75, 100), 
                       include.lowest=TRUE, brackets=TRUE)
impervious <- focal(impervious, w = 5, fun="median") 
impervious <- aggregate(impervious, fact = 8, fun = 'median')
plot(impervious)

writeRaster(impervious, overwrite = T, 
            filename = file.path(praw, 'landcover', 'Impervious_surfaces.tif'))

rm(rast_ext, r, ag, water, snow, urban, impervious)
```

```{r import impervious sufaces make vector, eval = F}

impervious <- rast(file.path(praw, 'landcover', 'Impervious_surfaces.tif'))
impervious_vect <- as.polygons(impervious)
plot(impervious_vect)

impervious_sf <- impervious_vect %>% 
  st_as_sf() %>% 
  st_simplify() %>% 
  st_cast('POLYGON')

impervious_sf - impervious_sf %>% 
  mutate(area = as.numeric(st_area(impervious_sf)) / 1000000) 

impervious_sf <- impervious_sf %>% 
  filter(focal_median == 1) %>% 
  st_simplify() %>% 
  filter(area > 20)

ggplot(impervious_sf) +
  geom_sf(aes(fill = focal_median), color = NA)

rm(impervious, impervious_vect)
```

```{r grid creation and occurrence counting, eval = F}

focal <- read.csv(file.path(praw, 'BIEN_focal_occurrences.csv')) %>%
  filter(scrubbed_species_binomial == 'Achnatherum nelsonii')

species_records <- focal %>% 
  st_as_sf(coords = c(x = 'longitude', y = 'latitude'), crs = 4326) %>% 
  group_by(scrubbed_species_binomial) %>% 
  summarize(records = n()) %>% 
  mutate(pairs = round(records/2,0), .before = geometry)

species_records_dt <- species_records %>% 
  st_drop_geometry() 
species_records_dt <- setDT(species_records_dt, key = 'pairs')

reference_multiples <- data.table(
  multipliers = 2:100
)[,pairs := multipliers * multipliers]
reference_multiples <- setkey(reference_multiples, pairs) # set the tables key

# this gives us the number of cells to make
species_records_dt <- reference_multiples[species_records_dt, roll = T]

grid <- st_make_grid(x = species_records, 
                     what = "polygons", n = species_records_dt$multipliers) %>% 
  st_as_sf() %>% 
  mutate(ID = 1:n(), .before = x) %>% 
  rename(geometry = x)

ggplot() +
  geom_sf(data = grid, fill = NA) +
  geom_sf(data = species_records) + 
  theme_bw()

# this supplies the number of cells which contain OCCUPANCIES Of the species
occupied_cells <- st_join(grid, species_records) %>% 
  drop_na(scrubbed_species_binomial)

# this supplies the number of cells which are to be removed due to not enough natural areas
impervious_cells <- st_intersection(grid, impervious_sf) %>% 
  mutate(intersect_area = as.numeric(st_area(.))) %>%   # create new column with shape area  
  select(ID, intersect_area) %>% 
  st_drop_geometry() %>% 
  group_by(ID) %>% 
  summarise(intersect_area = sum(intersect_area)) %>% 
  mutate(intersect_pct =
           (intersect_area / as.numeric(st_area(grid[1,]))) * 100 ) %>% 
  filter(intersect_pct > 50) %>% 
  
  # purely for visualization to ensure the process works
  left_join(., grid, by = 'ID')

impervious_cells <- st_as_sf(impervious_cells)

ggplot() + 
  geom_sf(data = grid, fill = NA) +
  geom_sf(data = occupied_cells, fill = 'green') + 
  geom_sf(data = impervious_cells, fill = 'red') +
  geom_sf(data = species_records) +
  geom_sf(data = impervious_sf, fill = 'yellow', alpha = 0.4) +
  theme_bw()
```

```{r Rasterfy habitat Ranges and extract to point, eval = F}

l4eco <- vect(file.path(praw, list.files(praw, recursive = T, pattern = 'l4.*shp$')))
l3eco <- vect(file.path(praw, list.files(praw, recursive = T, pattern = 'Level3.*shp$')))
l4eco <- project(l4eco, crs(l3eco))

e <- ext(l4eco)
l4eco_rast <- rast(
  resolution = 1000,
  ymin = e[3], ymax = e[4], xmin = e[1], xmax = e[2],
  crs = crs(l4eco))
l4eco_rast <- rasterize(l4eco, l4eco_rast, field = 'US_L4CODE')

e <- ext(l3eco)
l3eco_rast <- rast(
  resolution = 2000,
  ymin = e[3], ymax = e[4], xmin = e[1], xmax = e[2],
  crs = crs(l4eco))
l3eco_rast <- rasterize(l3eco, l3eco_rast, field = 'NA_L3CODE')

r <- rast(nrows=3, ncols=3, xmin=0, xmax=10, ymin=0, ymax=10)
values(r) <- 1:ncell(r)
s <- rast(nrows=25, ncols=30, xmin=1, xmax=11, ymin=-1, ymax=11)
x <- resample(r, s, method="bilinear")

eco_rast <- rasterize(eco, eco_rast, field = 'Code', filename = file.path(ppro, 'Ecoregion_raster.tif'))
plot(l3eco_rast)

rm(e)
```

```{r remove method related variables}
rm(f, fed, files, ppro, praw)
```

## Results & Discussions

The original AIM Species Richness data set contained `r no_records_full` plot based observations from `r length(unique(spp_richness$PLOTID))` plots. After removing `r unks` morphotypes which were not identified (`r paste0(round(((unks/no_records_full) * 100),2), '%')` of all records), dropping the `r num_pr(nrow(spp_dirty))` records which were not identified beyond genus (`r paste0(round(((nrow(spp_dirty)/no_records_full) * 100),2), '%')` of all records), and removing `r (n_w_syn - nrow(spp_clean))` synonymous taxa at the same plot (`r paste0(round(((n_w_syn - nrow(spp_clean)) / nrow(spp_clean) * 100), 2), '%')`), `r nrow(spp_clean)` records were left. These records represented `r nrow(records)` distinct terminal taxa, i.e. final taxonomic units - species were not double-counted with their sole infraspecific (varieties or subspecies) taxa. These records are more or less in accord with the states most current Floristic treatment (@ackerfield2015flora), and the USDA Plants database.

The CNHP rankings include many species which are considered rare by agencies with different foci and intentions than the BLM. While their initial list is comprised of `r nrow(tracked)` taxa, different organizations and agencies have different criteria for interpreting and classifying susceptibility of a species to extinction and loss of populations. The most rigorous and selective conditions, the Endangered Species Act, are enforced the United States Fish and Wildlife Service (USFWS), whom maintain the only official registries and implement the evaluation procedures for 'Threatened' and 'Endangered' species. These categories represent species with high probabilities of extinction in the wild, in the near future, due to anthropogenic changes; Endangered Species represent the more severe category of the two. Colorado contains `r nrow(esa)` species tracked by the USFWS, `r num_pr(nrow(esa[esa$USESA=='LT',]))` of these species are threatened with extinction, and `r num_pr(nrow(esa[esa$USESA=='LE',]))` are immediately endangered. Of the species tracked under the Endangered Species Act `r num_pr(length(unique(fws_esa$BINOMIAL_NAT)))` species, `r paste0('*', unique(fws_esa$BINOMIAL_NAT), '*')`, was found at `r num_pr(length(unique(fws_esa$PLOTID)))` plots. 

The Bureau of Land Management officially tracks plants which are of conservation concern on their lands, and which may be petitioned to be elevated to the more stringent categories implemented by the Fish and Wildlife Service, but which are mostly undergoing further assessment. As the BLM is apart of the federal government, these tracked taxa do not contain any redundancies with the Endangered Species Act list. BLM Colorado has `r nrow(blm)` sensitive species. Of the `r num_pr( length(unique(blm_ss$BINOMIAL_NAT)))` BLM sensitive species, `r toString(unique(blm_ss$BINOMIAL_NAT))`, were found at a total of `r num_pr(length(unique(blm_ss$PLOTID)))` plots. 

Several Non-Governmental Organizations (NGO's) also maintain their own information on species of concern, utilizing different methods and assessments than Government Agencies. A large portion of there goals are to form networks which are global in scale, rather than restricted to state actors, allowing for more comprehensive views of biological ranges and processes. Accordingly, they have a more integrated global perspective on species, and then make assessments of susceptibility to extinction at administrative units to assist local planners. One such agency is NatureServe. NatureServe uses a tiered ranking system, from 5-1, with lower values indicating susceptibility of a taxon to extinction at a either a Global or State level. Values '3' and below are taxa that warrant conservation considerations. The number of low value species, are greater at lower administrative levels, oftentimes due to species ranges crossing multiple administrative units. The number of S3 ('S' short for 'State') or lower (S2, S1) species in Colorado is `r nrow(state)`, and the subset of these which are globally tracked species with G3 ('G' short for 'Global')  or lower ranks is `r nrow(global)`. These two lists are not independent of the government data, for example the State list contains `r sum(state$GNAME %in% esa$GNAME)` of `r nrow(esa)` FWS species, while the global list contains `r sum(global$GNAME %in% esa$GNAME)` of them. In addition, the state list contains `r sum(state$GNAME %in% blm$GNAME)` of the `r nrow(blm)` BLM Sensitive Species, while the global list contains `r sum(global$GNAME %in% blm$GNAME)`. We subtract these species from these two lists and end up with a total of `r nrow(state_sub)` species on the state and `r nrow(global_sub)` species on the global lists to avoid confusion in reporting. We further remove the species present in the state list from the global list reducing the state list to `r nrow(state_sub1)`,  which maintains the global list at `r nrow(global_sub)`. Of the state species `r length(unique(state_aim$SYMBOL_USDA))`,  were found at a total of `r length(unique(state_aim$PLOTID))` plots, for a total of `r nrow(state_aim)` records. Of the state species `r length(unique(global_aim$SYMBOL_USDA))`,  were found at a total of `r length(unique(global_aim$PLOTID))` plots, for a total of `r nrow(global_aim)` records. 

A fascinating rare plant recorded on the AIM plots was *Mentzelia paradoxensis* J. J. Schenk & L. Hufford, a taxon described as new to science in 2010. This was found at a single plot, in the Paradox Valley, the locality from which it was collected in by prolific Intermountain West botanists Noel and Patricia Holmgren. This species hypothesis is so new, relatively little testing of it has been carried out, and to date the Colorado Natural Heritage Program has not evaluated the conservation status of it. Botanical collectors have determined it to be present in both the Paradox and the nearby Big Gypsum Valley, in both instances growing on stream terraces with elevated gypsum content. 

In regards to species which are rare within the UFO, but not of conservation concern, two methods 'singletons' and 'Gastons Quantile', returned identical results. Both methods suggest that there are `r nrow(gastons_rare)` rare species. The convergence of values implicates two methodological limitations. In regards to singletons, these records generally come from floristic inventories, wherein a well trained botanist is unconstrained by the dimensions of plots, and is able to roam a large area using their knowledge of an area and intuition. In the case of a field office wide inventory, they would be able to allocate considerable less time to certain Ecological Sites with very few species, in lieu of spending more time in areas with many species. We do feel after several more AIM sample frames this will start to deliver quite effective results. Regarding Gastons Quintile, or the lower 25% of records, this may indicate an inconsistency in goals of survey work. Many ecologists in the era in which this metric was derived were oftentimes explicitly surveying for species diversity and abundance metrics, whereas AIM serves to characterize landscape units, as delimited by geomorphology. Accordingly, the ecologist of yesteryear strove to maximize variation between plots, while the rangeland ecologist of today seeks to maximize statistical inference across landscapes. That such a significant number of species only occurred at a single plot, may in part reflect that a single Sample Frame of AIM data is not enough to start to gather information on the biotic composition of this field office. However, we see no reasons that future results for Gaston's Index would be significantly different than the species composition presented here, and believe that many of the singleton's identified here, would be singleton's again after combing these data with  those in the next sample frame. 

```{r similarity conservation concern and locally rare}
cc <- unique(c(fws_esa$SYMBOL_USDA, global_aim$SYMBOL_AIM, 
                          state_aim$SYMBOL_AIM, blm_ss$SYMBOL_AIM)) # 27 spp. 

gr_ncc <- gastons_rare %>% filter(!SYMBOL_USDA %in% cc)
```

Of the `r nrow(gastons_rare)` species identified by Gaston's and the Singleton method `r nrow(gastons_rare) - nrow(gr_ncc)` overlap with the `r length(cc)` species of conservation concern which were found on plots. It is expected that these approaches would give different results, given that rare species tend to be abundant in portions of their ranges. 

As evidenced here, the field office has a variety of rare plant taxa which contribute enormously to the biological diversity of the field office.


```{r create table to present results}

fw <- fws_esa %>% 
  select(PLOTID, SYMBOL_USDA, BINOMIAL_NAT) %>% 
  mutate(AGENCY = 'FWS') %>% 
  st_drop_geometry() %>% 
  arrange(BINOMIAL_NAT)

bl <- blm_ss %>% 
  select(PLOTID, SYMBOL_USDA, BINOMIAL_NAT) %>% 
  mutate(AGENCY = 'BLM',  
         BINOMIAL_NAT = str_remove_all(BINOMIAL_NAT, '[*]')) %>% 
  st_drop_geometry()  %>% 
  ungroup()  %>% 
  arrange(BINOMIAL_NAT)

gl <- global_aim %>% 
  select(PLOTID, SYMBOL_USDA, BINOMIAL_NAT) %>% 
  filter(SYMBOL_USDA != 'PHBE2') %>% 
  mutate(AGENCY = 'NatureServe - Global', 
         BINOMIAL_NAT = case_when(
           SYMBOL_USDA == 'CLPA3' ~ 'Cleomella palmeriana', 
           SYMBOL_USDA == 'CRLO6' ~ 'Oreocarya longiflora', 
           SYMBOL_USDA == 'DRRE' ~ 'Draba rectifructa',
           SYMBOL_USDA == 'ERLE10' ~ 'Eriogonum leptophyllum',
           SYMBOL_USDA == 'ERNE2' ~ 'Erigeron nematophyllus', 
           SYMBOL_USDA == 'LECR12' ~ 'Lepidium crenatum',
           SYMBOL_USDA == 'MECR4' ~ 'Mentzelia cronquistii',
           SYMBOL_USDA == 'PEBR9' ~ 'Penstemon breviculus',
           SYMBOL_USDA == 'PETE9' ~ 'Penstemon teucrioides',
           SYMBOL_USDA == 'POSA19' ~ 'Polypodium saximontanum',
           SYMBOL_USDA == 'STAL2' ~ 'Stanleya albescens',
           SYMBOL_USDA == 'TOGL4' ~ 'Townsendia glabella'
         )) %>% 
  st_drop_geometry()  %>% 
  arrange(BINOMIAL_NAT)

st <- state_aim %>% 
  select(PLOTID, SYMBOL_USDA, BINOMIAL_NAT) %>% 
  filter(!SYMBOL_USDA %in% unique(global_aim$SYMBOL_USDA)) %>% 
    mutate(AGENCY = 'NatureServe - State', 
         BINOMIAL_NAT = case_when( 
           SYMBOL_USDA == 'CODI4' ~ 'Commelina dianthifolia', 
           SYMBOL_USDA == 'MIAL5' ~ 'Mirabilis alipes', 
           SYMBOL_USDA == 'PEME7' ~ 'Pediomelum megalanthum',
           SYMBOL_USDA == 'ENNU' ~ 'Eriogonum leptophyllum',
           SYMBOL_USDA == 'OXPA2' ~ 'Oxytropis parryi', 
           SYMBOL_USDA == 'ASMOC2' ~ 'Astragalus monumentalis var. cottamii',
           SYMBOL_USDA == 'CAFL' ~  'Calochortus flexuosus', 
           SYMBOL_USDA == 'ERLA' ~ 'Erigeron lanatus'
         )) %>% 
  st_drop_geometry() %>% 
  arrange(BINOMIAL_NAT)

bind_rows(fw, bl, gl, st) %>%
  ungroup() %>% 
  select(-SYMBOL_USDA) %>% 
  group_by(BINOMIAL_NAT) %>% 
  nest(Plots = PLOTID) %>% 
  knitr::kable(col.names = c('Scientific Name', 'Authority', 'Plots'), 
               align = c('c', 'c', 'l'),
               caption = 'Species found and plots found at.', 
               format="latex", booktabs = F) %>% 
  kableExtra::kable_styling(latex_options = "scale_down") %>% 
  kableExtra::row_spec(0,bold=TRUE) %>% 
  kableExtra::column_spec(1, width = "12em") %>% 
  kableExtra::column_spec(2, width = "7em") %>% 
  kableExtra::column_spec(3, width = "30em") %>% 
  kableExtra::collapse_rows() %>% 
  kableExtra::landscape()
  
```


```{r remove writing variables}
rm(esa, fws_esa, blm, blm_ss, state, global, global_sub, state_sub, 
   state_sub1, state_aim, global_aim, cc, gr_ncc, gastons, gastons_rare, singletons,
   spp_dirty, tracked, unks, spp_richness, n_w_syn, no_records_full)
```


## References

\small

